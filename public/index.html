<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acortador de URLs</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”— Acortador de URLs</h1>
            <p>Acorta tus enlaces de forma rÃ¡pida y segura</p>
        </header>

        <main>
            <!-- Formulario de acortamiento -->
            <section class="shortener-form">
                <form id="shortenerForm">
                    <div class="form-group">
                        <label for="url">URL a acortar:</label>
                        <input type="url" id="url" name="url" placeholder="https://ejemplo.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="slug">Slug personalizado (opcional):</label>
                        <input type="text" id="slug" name="slug" placeholder="mi-slug-personalizado">
                        <small>Solo letras, nÃºmeros, guiones y guiones bajos</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ttl">TTL en segundos (opcional):</label>
                        <input type="number" id="ttl" name="ttl" placeholder="3600" min="1">
                        <small>Tiempo de vida del enlace en segundos</small>
                    </div>
                    
                    <button type="submit" id="submitBtn">Acortar URL</button>
                </form>
            </section>

            <!-- Resultado -->
            <section class="result" id="result" style="display: none;">
                <h3>âœ… Â¡URL acortada exitosamente!</h3>
                <div class="result-content">
                    <div class="url-display">
                        <input type="text" id="shortUrl" readonly>
                        <button id="copyBtn" onclick="copyToClipboard()">Copiar</button>
                    </div>
                    <div class="qr-section">
                        <img id="qrCode" alt="CÃ³digo QR">
                        <p>Escanea el cÃ³digo QR para acceder al enlace</p>
                        <div class="qr-buttons">
                            <button id="downloadQrBtn" onclick="downloadQR()" class="btn-small">Descargar QR</button>
                            <button id="refreshQrBtn" onclick="refreshQR()" class="btn-small">Refrescar QR</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Historial local -->
            <section class="history">
                <h3>ðŸ“‹ Tu Historial</h3>
                <div id="historyList" class="history-list">
                    <p class="empty-history">No tienes enlaces acortados aÃºn</p>
                </div>
            </section>
        </main>

        <footer>
            <p>
                <a href="/admin">Panel de AdministraciÃ³n</a> | 
                <a href="#" onclick="clearHistory()">Limpiar Historial</a>
            </p>
        </footer>
    </div>

    <script>
        // Estado global
        let currentSession = null;

        // Inicializar sesiÃ³n al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeSession();
            loadHistory();
        });

        // Inicializar sesiÃ³n
        async function initializeSession() {
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                if (data.ok) {
                    currentSession = data.sid;
                }
            } catch (error) {
                console.error('Error inicializando sesiÃ³n:', error);
            }
        }

        // Manejar envÃ­o del formulario
        document.getElementById('shortenerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                url: formData.get('url'),
                slug: formData.get('slug') || undefined,
                ttl: formData.get('ttl') ? parseInt(formData.get('ttl')) : undefined
            };

            try {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Acortando...';

                const response = await fetch('/api/links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(result);
                    addToHistory(result);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al acortar la URL');
            } finally {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Acortar URL';
            }
        });

        // Mostrar resultado
        function showResult(result) {
            const resultSection = document.getElementById('result');
            const shortUrlInput = document.getElementById('shortUrl');
            const qrCodeImg = document.getElementById('qrCode');
            
            shortUrlInput.value = `https://${window.location.host}/${result.slug}`;
            // Agregar timestamp para evitar cache
            const timestamp = Date.now();
            qrCodeImg.src = `/api/qr?slug=${result.slug}&t=${timestamp}`;
            
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Copiar al portapapeles
        function copyToClipboard() {
            const shortUrlInput = document.getElementById('shortUrl');
            shortUrlInput.select();
            document.execCommand('copy');
            
            const copyBtn = document.getElementById('copyBtn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Â¡Copiado!';
            setTimeout(() => {
                copyBtn.textContent = originalText;
            }, 2000);
        }

        // Descargar QR
        function downloadQR() {
            const qrImg = document.getElementById('qrCode');
            const shortUrl = document.getElementById('shortUrl').value;
            const slug = shortUrl.split('/').pop();
            
            // Crear enlace de descarga con timestamp
            const link = document.createElement('a');
            const timestamp = Date.now();
            link.href = `/api/qr?slug=${slug}&t=${timestamp}`;
            link.download = `qr-${slug}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refrescar QR
        function refreshQR() {
            const qrImg = document.getElementById('qrCode');
            const shortUrl = document.getElementById('shortUrl').value;
            const slug = shortUrl.split('/').pop();
            
            // Forzar recarga con nuevo timestamp
            const timestamp = Date.now();
            qrImg.src = `/api/qr?slug=${slug}&t=${timestamp}`;
            
            // Mostrar mensaje
            const refreshBtn = document.getElementById('refreshQrBtn');
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = 'Â¡Refrescado!';
            setTimeout(() => {
                refreshBtn.textContent = originalText;
            }, 2000);
        }

        // Descargar QR desde el modal
        function downloadQRFromModal(slug) {
            const link = document.createElement('a');
            const timestamp = Date.now();
            link.href = `/api/qr?slug=${slug}&t=${timestamp}`;
            link.download = `qr-${slug}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Agregar al historial local
        function addToHistory(linkData) {
            const history = getHistory();
            const newLink = {
                ...linkData,
                createdAt: Date.now(),
                totalClicks: 0
            };
            
            history.unshift(newLink);
            localStorage.setItem('shortener:history', JSON.stringify(history));
            loadHistory();
        }

        // Obtener historial local
        function getHistory() {
            const stored = localStorage.getItem('shortener:history');
            return stored ? JSON.parse(stored) : [];
        }

        // Cargar historial
        function loadHistory() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="empty-history">No tienes enlaces acortados aÃºn</p>';
                return;
            }

            historyList.innerHTML = history.map(link => `
                <div class="history-item">
                    <div class="link-info">
                        <div class="original-url">${link.url}</div>
                        <div class="short-url">https://${window.location.host}/${link.slug}</div>
                        <div class="link-meta">
                            Creado: ${new Date(link.createdAt).toLocaleString()}
                            ${link.totalClicks > 0 ? ` | Clicks: ${link.totalClicks}` : ''}
                        </div>
                    </div>
                    <div class="link-actions">
                        <button onclick="copyLink('${link.slug}')" class="btn-small">Copiar</button>
                        <button onclick="viewQR('${link.slug}')" class="btn-small">Ver QR</button>
                        <button onclick="editLink('${link.slug}')" class="btn-small">Editar</button>
                        <button onclick="deleteLink('${link.slug}')" class="btn-small danger">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        // Copiar enlace
        function copyLink(slug) {
            const url = `https://${window.location.host}/${slug}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('Enlace copiado al portapapeles');
            });
        }

        // Ver QR
        function viewQR(slug) {
            // Crear modal para mostrar QR
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>CÃ³digo QR</h3>
                        <button onclick="closeModal()" class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="qr-display">
                            <img src="/api/qr?slug=${slug}&t=${Date.now()}" alt="CÃ³digo QR" style="max-width: 300px; height: auto;">
                            <p>Escanea el cÃ³digo QR para acceder al enlace</p>
                            <button onclick="downloadQRFromModal('${slug}')" class="btn">Descargar QR</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }



        // Cerrar modal
        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Editar enlace
        async function editLink(slug) {
            const newUrl = prompt('Nueva URL:');
            if (!newUrl) return;
            
            try {
                const response = await fetch(`/api/link-edit?slug=${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: newUrl })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Enlace actualizado exitosamente');
                    loadHistory();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error editando enlace:', error);
                alert('Error al editar enlace');
            }
        }

        // Eliminar enlace
        async function deleteLink(slug) {
            if (!confirm('Â¿EstÃ¡s seguro de que quieres eliminar este enlace?')) return;
            
            try {
                const response = await fetch(`/api/link-delete?slug=${slug}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Enlace eliminado exitosamente');
                    removeFromHistory(slug);
                    loadHistory();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error eliminando enlace:', error);
                alert('Error al eliminar enlace');
            }
        }

        // Remover del historial local
        function removeFromHistory(slug) {
            const history = getHistory();
            const filtered = history.filter(link => link.slug !== slug);
            localStorage.setItem('shortener:history', JSON.stringify(filtered));
        }

        // Limpiar historial
        function clearHistory() {
            if (confirm('Â¿EstÃ¡s seguro de que quieres limpiar todo el historial?')) {
                localStorage.removeItem('shortener:history');
                loadHistory();
            }
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
